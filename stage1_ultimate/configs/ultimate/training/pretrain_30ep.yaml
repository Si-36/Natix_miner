# ══════════════════════════════════════════════════════════════
# TRAINING CONFIGURATION - PRETRAINING (30 EPOCHS)
# ══════════════════════════════════════════════════════════════

# ══════════════════════════════════════════════════════════════
# BASIC TRAINING PARAMETERS
# ══════════════════════════════════════════════════════════════

num_epochs: 30
learning_rate: 1e-4
weight_decay: 0.01
batch_size: 8
gradient_accumulation_steps: 4  # Effective batch: 8 * 4 = 32

# ══════════════════════════════════════════════════════════════
# OPTIMIZER CONFIGURATION
# ══════════════════════════════════════════════════════════════

optimizer:
  # Sophia-H (2026 SOTA)
  sophia:
    enabled: true
    betas: [0.965, 0.99]
    rho: 0.04
    is_third_order: true  # Use Hessian diagonal
  
  # Fallback to AdamW
  adamw:
    enabled: false
    betas: [0.9, 0.999]
    eps: 1e-8

# ══════════════════════════════════════════════════════════════
# SCHEDULER CONFIGURATION
# ══════════════════════════════════════════════════════════════

warmup_steps: 500
warmup_ratio: 0.05  # 5% of training for warmup
min_lr_ratio: 0.1  # Final LR = 10% of peak

# Cosine decay parameters
cosine_scheduler:
  num_cycles: 0.5  # Half cosine cycle

# ══════════════════════════════════════════════════════════════
# GRADIENT CLIPPING
# ══════════════════════════════════════════════════════════════

max_grad_norm: 1.0
grad_clip_type: "norm"  # or "value"

# ══════════════════════════════════════════════════════════════
# PRECISION & MEMORY
# ══════════════════════════════════════════════════════════════

precision: "bfloat16"  # or "float16" or "float32"
mixed_precision: true
gradient_checkpointing: true

# ══════════════════════════════════════════════════════════════
# EARLY STOPPING
# ══════════════════════════════════════════════════════════════

early_stopping_patience: 5
early_stopping_monitor: "val_mcc"
early_stopping_mode: "max"

# ══════════════════════════════════════════════════════════════
# EMA (EXPONENTIAL MOVING AVERAGE)
# ══════════════════════════════════════════════════════════════

ema:
  enabled: true
  decay: 0.9999
  update_after_step: 0
  update_every: 1

# ══════════════════════════════════════════════════════════════
# VALIDATION
# ══════════════════════════════════════════════════════════════

validation:
  interval: 1  # Validate every epoch
  save_top_k: 3  # Save top 3 checkpoints

# ══════════════════════════════════════════════════════════════
# LOGGING
# ══════════════════════════════════════════════════════════════

logging:
  enabled: true
  
  wandb:
    enabled: true
    project_name: "natix-roadwork-2026"
    entity: null
    mode: "online"  # "online", "offline", "disabled"
    run_name: null
    notes: "Ultimate 2026 model pre-training (30 epochs)"
    tags: ["2026", "pretrain", "ultimate"]
  
  tensorboard:
    enabled: false
    log_dir: "outputs/tensorboard"

# ══════════════════════════════════════════════════════════════
# CHECKPOINTING
# ══════════════════════════════════════════════════════════════

checkpointing:
  save_dir: "outputs/checkpoints/pretrain"
  save_interval: 1  # Save every epoch
  save_optimizer: true
  save_scheduler: true

# ══════════════════════════════════════════════════════════════
# DATA CONFIGURATION
# ══════════════════════════════════════════════════════════════

data:
  # Dataset paths
  train_dir: "data/natix/train"
  val_dir: "data/natix/val"
  test_dir: "data/natix/test"
  
  # Data loader
  num_workers: 4
  pin_memory: true
  drop_last: true
  shuffle: true
  
  # Expected dataset sizes
  train_size: 8549
  val_size: 1000
  test_size: 251

# ══════════════════════════════════════════════════════════════
# GPS WEIGHTED SAMPLING (BIGGEST WIN!)
# ══════════════════════════════════════════════════════════════

gps:
  enabled: true
  # GPS-weighted sampling increases test set similarity
  # Expected gain: +7-10% MCC
  
  # Sampling strategy
  similarity_threshold: 0.8  # 80% GPS similarity
  sampling_alpha: 2.0  # Focus more on similar regions
  
  # Expected impact
  expected_mcc_gain: 0.08  # +8% MCC

# ══════════════════════════════════════════════════════════════
# AUGMENTATION
# ══════════════════════════════════════════════════════════════

augmentation:
  enabled: true
  
  # Geometric
  random_crop: true
  random_flip: true
  rotation: 15  # Max rotation in degrees
  
  # Color
  color_jitter: true
  brightness: 0.3
  contrast: 0.3
  saturation: 0.2
  hue: 0.1
  
  # Multi-view specific
  multi_view_consistency: true

# ══════════════════════════════════════════════════════════════
# EXPECTED PERFORMANCE
# ══════════════════════════════════════════════════════════════

performance:
  # Expected MCC after 30 epochs
  expected_val_mcc: [0.94, 0.96]
  expected_test_mcc: [0.95, 0.97]
  
  # Training speed
  base_throughput: "8_images_per_second"
  expected_throughput: "11.2_images_per_second"  # With compile
  
  # Memory usage
  peak_memory: "140GB"  # For dual H100s
  
  # ROI
  expected_roi_weeks: 2-3  # System pays for itself in 2-3 weeks
