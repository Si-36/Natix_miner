# NATIX Dataset Configuration
# Latest 2025-2026 Practices
#
# NATIX StreetVision:
#   - Roadwork classification
#   - 7 classes
#   - ~10K images (estimated)
#   - Real-world street conditions

# Dataset paths (FIXED: Absolute path + 13 classes)
data_root: /data/natix  # TODO: Override with your actual path via CLI
train_csv: ${data_root}/train.csv
val_csv: ${data_root}/val.csv
test_csv: ${data_root}/test.csv

# Classes (ACTUAL: 2 classes in HuggingFace NATIX dataset)
num_classes: 2
class_names:
  - class_0  # no_roadwork (based on dataset inspection)
  - class_1  # roadwork (based on dataset inspection)

# Class weights (auto-computed if null)
class_weights: null  # Will be computed from training data

# Data splits (4-way split for zero leakage)
splits:
  train_ratio: 0.7
  val_select_ratio: 0.1  # For model selection (early stopping)
  val_calib_ratio: 0.1   # For policy fitting (threshold, gate, SCRC)
  val_test_ratio: 0.1    # For final evaluation ONLY

# Image preprocessing
preprocessing:
  # Training (224×224 crops for speed + regularization)
  resize: 224  # DINOv3 standard resolution
  crop_size: 224
  mean: [0.485, 0.456, 0.406]  # ImageNet mean
  std: [0.229, 0.224, 0.225]   # ImageNet std
  interpolation: bilinear

  # Eval (high-res canvas for max accuracy)
  eval_mode: letterbox_canvas  # "center_crop_224" (legacy) or "letterbox_canvas" (best)
  eval_canvas_size: 896  # Start with 896, can increase to 1024/1280 (VRAM permitting)
  eval_letterbox: true  # Preserve aspect ratio, pad to square
  eval_multiscale: false  # Set true for multi-scale ensemble (896 + 1024)
  eval_canvas_sizes: [896, 1024]  # Used if eval_multiscale=true

# Data loading
dataloader:
  batch_size: 32  # Training batch size
  val_batch_size: 8  # Eval batch size (smaller due to multi-view)
  num_workers: 8
  pin_memory: true
  persistent_workers: true
  prefetch_factor: 2

# Augmentation (train)
augmentation:
  train:
    horizontal_flip: 0.5
    vertical_flip: 0.0
    rotation: 15
    color_jitter:
      brightness: 0.4
      contrast: 0.4
      saturation: 0.4
      hue: 0.1
    auto_augment: true
    random_erasing: 0.1

  # No augmentation for val/test (but use high-res canvas)
  val:
    # NOTE: Actual transform determined by preprocessing.eval_mode
    # If eval_mode=letterbox_canvas: uses letterbox to eval_canvas_size
    # If eval_mode=center_crop_224: uses legacy Resize(256) + CenterCrop(224)
    center_crop: false  # Disabled when using letterbox

# Multi-view settings (for validation/test only)
multiview:
  enabled: true
  # With high-res canvas (e.g., 896×896), multi-view generates:
  # - 1 global view (resized to 224×224)
  # - N×N tiles (each 224×224) using roi_align
  # Then aggregates logits using topk_mean or attention

  grid_size: [3, 3]  # 3×3 = 9 tiles (can increase to [4, 4] or [5, 5] if VRAM allows)
  overlap: 0.15  # 15% overlap between tiles (improves coverage)
  content_aware_tiling: true  # Only tile content region (skip padding)

# Slice-based evaluation
slicing:
  enabled: true
  slices:
    - name: day
      filter: time_of_day == "day"
    - name: night
      filter: time_of_day == "night"
    - name: clear
      filter: weather == "clear"
    - name: rain
      filter: weather == "rain"
    - name: snow
      filter: weather == "snow"

# Data quality checks
quality:
  min_image_size: 224  # Minimum image dimension
  max_aspect_ratio: 3.0  # Reject extreme aspect ratios
  check_corrupted: true  # Check for corrupted images
